# GitHub Actions Workflow - Frontend Deployment
name: Deploy Frontend to Production

on:
  push:
    branches:
      - master
    paths:
      - 'src/**'
      - 'public/**'
      - 'index.html'
      - 'package.json'
      - 'package-lock.json'
      - 'vite.config.js'
      - '.env.production'
      - '.github/workflows/deploy-frontend.yml'
  workflow_dispatch: # Allows manual trigger from GitHub UI

jobs:
  deploy:
    name: Build and Deploy React Frontend
    runs-on: ubuntu-latest
    
    steps:
      # Step 1: Check out the repository code
      - name: Checkout code
        uses: actions/checkout@v4
        
      # Step 2: Set up Node.js
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      # Step 3: Install dependencies
      - name: Install dependencies
        run: npm ci
        
      # Step 4: Build production bundle
      - name: Build production bundle
        env:
          VITE_API_BASE_URL: ${{ secrets.VITE_API_BASE_URL }}
        run: npm run build
        
      # Step 5: Verify build output
      - name: Verify build output
        run: |
          if [ ! -d "dist" ]; then
            echo "dist/ directory not found!"
            exit 1
          fi
          echo "Build successful. Contents of dist/:"
          ls -lah dist/
          
      # Step 6: Install SSH key
      - name: Install SSH key
        run: |
          install -m 600 -D /dev/null ~/.ssh/id_rsa
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts
          
      # Step 7: Clean old files on server
      - name: Clean old files on server
        run: |
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} \
            "rm -rf /var/www/doors-portal/dist/*"
          
      # Step 8: Upload build files to server
      - name: Upload build files to server
        run: |
          scp -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no -r \
            dist/* \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:/var/www/doors-portal/dist/
          
      # Step 9: Set correct permissions
      - name: Set correct permissions
        run: |
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} \
            "chmod -R 755 /var/www/doors-portal/dist"
          
      # Step 10: Reload Nginx
      - name: Reload Nginx
        run: |
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} \
            "sudo systemctl reload nginx"
          
      # Step 11: Verify Nginx is running
      - name: Verify Nginx status
        run: |
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} \
            "sudo systemctl status nginx --no-pager"
          
      # Step 12: Test if the frontend is accessible
      - name: Test frontend accessibility
        run: |
          sleep 5
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://${{ secrets.SERVER_HOST }}/)
          if [ "$HTTP_CODE" -eq 200 ]; then
            echo "Frontend is accessible (HTTP $HTTP_CODE)"
          else
            echo "Frontend returned unexpected status (HTTP $HTTP_CODE)"
            exit 1
          fi
          
      # Step 13: Test API connectivity through Nginx
      - name: Test API proxy
        run: |
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://${{ secrets.SERVER_HOST }}/api/clients)
          if [ "$HTTP_CODE" -eq 200 ]; then
            echo "API proxy is working (HTTP $HTTP_CODE)"
          else
            echo "API returned status: HTTP $HTTP_CODE"
          fi
          
      # Step 14: Deployment summary
      - name: Deployment summary
        if: success()
        run: |
          echo "Frontend deployment completed successfully!"
          echo "Files deployed to: /var/www/doors-portal/dist/"
          echo "Nginx reloaded"
          echo "Frontend available at: http://${{ secrets.SERVER_HOST }}/"
          echo "API accessible at: http://${{ secrets.SERVER_HOST }}/api/clients"
